syntax = "proto3";

package car;

// Go package path - REQUIRED for protoc-gen-go
option go_package = "./proto";

service CarService {
  // Client checks in and receives static data (cars, track)
  rpc CheckIn(RegisterPlayer) returns (CheckInResponse);
  
  // Get track info only (no authentication needed)
  rpc GetTrack(Empty) returns (TrackInfo);
  
  // Stream race updates to all clients (spectators + players)
  rpc StreamRaceUpdates(Empty) returns (stream RaceUpdate);

  // Players send input via unary request-response (grpc-web safe)
  rpc SendPlayerInput(PlayerInput) returns (InputAck);
}

// ---------------------------------------------------
// Generic empty message
message Empty {}

// ---------------------------------------------------
// 3D point for track boundaries (32-bit floats)
message Point3D {
  float x = 1;
  float y = 2;
  float z = 3;
}

// ---------------------------------------------------
// Track information - two boundary lines
message TrackInfo {
  string track_id = 1;
  string name = 2;
  repeated Point3D left_boundary = 3; // Left edge of track
  repeated Point3D right_boundary = 4; // Right edge of track
}
enum RaceType {
  HOTLAP = 0;
  QUALY = 1;
  RACEBYLAPS = 2;
  RACEBYTIME = 3;

}
message RaceDescription{
 RaceType racetype = 1; 
  int32 laps = 100;
  int32 time = 101;

}
// ---------------------------------------------------
// Static car information
message CarInfo {
  string car_id = 1; 
  float power = 3; // Engine power (0-100 scale)
  float weight = 4;
}

// ---------------------------------------------------
// Player registration request
message RegisterPlayer {
  string car_id = 1;
  string player_name = 2;
  string password = 3;
}

// ---------------------------------------------------
// CheckIn response with ack, static data, and auth token
message CheckInResponse {
  bool accepted = 1;
  string auth_token = 2; // Token to use in PlayerInput (empty for spectators)
  string message = 3; // Error or success message
  bool is_spectator = 4; // True if logged in as spectator

  TrackInfo track = 5; // Track boundaries
  RaceType race = 6;
}

// ---------------------------------------------------
// Player input controls
message PlayerInput {
  string car_id = 1;
  string auth_token = 2;

  float steering = 3; // -1.0 to 1.0
  float throttle = 4; // 0.0 to 1.0
  float brake = 5; // 0.0 to 1.0

  int32 timestamp = 99;
}

// ---------------------------------------------------
// Input acknowledgment
message InputAck {
  bool accepted = 1;
  string reason = 2;
  int32 game_loop = 3;
}
enum CarStatus {
  NOTREADY = 0;
  WAITING = 1;
  RACING = 2;
  SERVINGPENALTY = 3;
  FINISHED = 99;
}
 

// ---------------------------------------------------
// Dynamic car state during race
message CarState {
  string car_id = 1;
  CarStatus status = 2;
  Point3D position = 3;
  float heading = 4;
  float speed = 5;
  int32 lap = 6;
  
}
message CarPenalty {
  string car_id = 1;
  string reason = 2;
  int32 game_tick = 3;
  int32 remaining_penalty = 4;
  
}
// ---------------------------------------------------
// Race status information
message RaceStatus {
  string status = 1; // "waiting", "racing", "finished"
  int32 total_laps = 2;
  int32 game_tick = 3;
}

message CarInterval{
  string car_id = 1;
  int32 position = 2;
  int32 laps = 3;
  float interval = 4;
  

}
// ---------------------------------------------------
// Race update (streamed continuously)
message RaceUpdate {
  RaceStatus race_status = 1;
  repeated CarState cars = 2;
  repeated CarPenalty penalties = 3;
  repeated CarInterval to_leader =4;
  repeated CarInterval for_position = 5;
  int32 game_tick = 100;
}