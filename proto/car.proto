syntax = "proto3";

package car;

// Go package path - REQUIRED for protoc-gen-go
option go_package = "./proto";

service CarService {
  // Client checks in and receives static data (cars, track)
  rpc CheckIn(RegisterPlayer) returns (CheckInResponse);
  
  // Get track info only (no authentication needed)
  rpc GetTrack(Empty) returns (TrackInfo);
  
  // Stream race updates to all clients (spectators + players)
  rpc StreamRaceUpdates(Empty) returns (stream RaceUpdate);

  // Players send input via unary request-response (grpc-web safe)
  rpc SendPlayerInput(PlayerInput) returns (InputAck);
}

// ---------------------------------------------------
// Generic empty message
message Empty {}

// ---------------------------------------------------
// 3D point for track boundaries (32-bit floats)
message Point3D {
  float x = 1;
  float y = 2;
  float z = 3;
}

// ---------------------------------------------------
// Track information - two boundary lines
message TrackInfo {
  string track_id = 1;
  string name = 2;
  repeated Point3D left_boundary = 3; // Left edge of track
  repeated Point3D right_boundary = 4; // Right edge of track
}

// ---------------------------------------------------
// Static car information
message CarInfo {
  string car_id = 1;
  string team = 2;
  float power = 3; // Engine power (0-100 scale)
  string color = 4; // Car color for display
  string driver = 5; // Driver name
}

// ---------------------------------------------------
// Player registration request
message RegisterPlayer {
  string car_id = 1;
  string player_name = 2;
  string password = 3;
}

// ---------------------------------------------------
// CheckIn response with ack, static data, and auth token
message CheckInResponse {
  bool accepted = 1;
  string auth_token = 2; // Token to use in PlayerInput (empty for spectators)
  string message = 3; // Error or success message
  bool is_spectator = 4; // True if logged in as spectator
  
  repeated CarInfo cars = 5; // All cars in race
  TrackInfo track = 6; // Track boundaries
}

// ---------------------------------------------------
// Player input controls
message PlayerInput {
  string car_id = 1;
  string auth_token = 2;

  float steering = 3; // -1.0 to 1.0
  float throttle = 4; // 0.0 to 1.0
  float brake = 5; // 0.0 to 1.0
  bool boost = 6;

  int32 timestamp = 7;
}

// ---------------------------------------------------
// Input acknowledgment
message InputAck {
  bool accepted = 1;
  string reason = 2;
  int32 game_loop = 3;
}

// ---------------------------------------------------
// Dynamic car state during race
message CarState {
  string car_id = 1;
  Point3D position = 2;
  float heading = 3;
  float speed = 4;
  int32 lap = 5;
  
  float current_steering = 6;
  float current_throttle = 7;
}

// ---------------------------------------------------
// Race status information
message RaceStatus {
  string status = 1; // "waiting", "racing", "finished"
  int32 total_laps = 2;
  int32 race_time = 3;
}

// ---------------------------------------------------
// Race update (streamed continuously)
message RaceUpdate {
  RaceStatus race_status = 1;
  repeated CarState cars = 2;
  int32 game_tick = 3;
}